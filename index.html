<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –§–ì–ò–° –§–°–ê</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setLogLevel, writeBatch, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for use in the main script block
        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, setLogLevel, writeBatch, getDocs, query
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
            min-height: 100vh;
            background-image: linear-gradient(0deg, transparent 14px, rgba(160, 174, 192, 0.15) 15px),
                              linear-gradient(90deg, transparent 14px, rgba(160, 174, 192, 0.15) 15px);
            background-size: 15px 15px; 
            background-attachment: fixed;
        }
        .main-card { background-color: #ffffff; }
        .drag-area { border: 3px dashed #94a3b8; transition: all 0.3s ease; }
        .drag-area.active { border-color: #0ea5e9; background-color: #f0f9ff; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2); }
        details[open] summary svg { transform: rotate(180deg); }
        
        @keyframes progress-stripes { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .animate-progress-stripes {
            width: 200%; animation: progress-stripes 2s linear infinite;
            background: linear-gradient(
                135deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%,
                rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent
            );
            background-size: 1rem 1rem;
            will-change: transform;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], },
                    colors: { 'accent-sky': '#0ea5e9', 'accent-emerald': '#10b981', }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-12">

    <!-- –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
    <div class="max-w-4xl mx-auto main-card p-6 md:p-10 rounded-xl shadow-xl border-t-4 border-accent-sky">
        <header class="mb-8 border-b border-gray-200 pb-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-1">
                <span class="text-accent-sky">|</span> –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–∞–Ω–Ω—ã—Ö <span class="text-accent-sky">–§–ì–ò–°</span>
            </h1>
            <p class="text-gray-500 text-base">
                –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—ã–≥—Ä—É–∑–∫–∏ "–ê–†–®–ò–ù" –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –§–ì–ò–° –§–°–ê.
            </p>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-2">–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: –ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </header>

        <!-- Input and Status Section -->
        <div class="space-y-6">
            
            <!-- –ë–õ–û–ö 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
            <div id="fileUploadSection">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">
                    –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ CSV
                </h2>
                <div id="drop-area" class="drag-area p-8 rounded-lg text-center cursor-pointer transition-all hover:ring-2 hover:ring-offset-2 hover:ring-sky-300">
                    <input type="file" id="fileInput" accept=".csv" class="hidden">
                    <svg class="mx-auto h-12 w-12 text-accent-sky" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4H7z" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">
                        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ CSV-—Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ <span class="text-accent-sky font-semibold">–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</span>
                    </p>
                    <p id="fileNameDisplay" class="text-xs text-gray-400 mt-1"></p>
                </div>
            </div>

            <!-- –ë–õ–û–ö 2: SNILS Management (–ü–µ—Ä–µ–º–µ—â–µ–Ω) -->
            <div id="snilsManagement" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2h2m-4-6a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 01-1.498-3.155L6 14v-2.5a4 4 0 014-4h.001M12 10a4 4 0 00-4-4H8a4 4 0 00-4 4v2.5L3.498 17A7 7 0 0011 20h2a7 7 0 007-7.498l-1.498-3.155z" /></svg>
                    –®–∞–≥ 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–ù–ò–õ–° (–í–∞—à–∞ –±–∞–∑–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π)
                </h2>
                <!-- –§–æ—Ä–º–∞ —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                <form id="addMappingForm" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4 p-3 bg-white rounded-lg border">
                    <input type="text" id="authorNameInput" placeholder="–§–ò–û –ê–≤—Ç–æ—Ä–∞ (–∫–∞–∫ –≤ CSV)" required
                           class="col-span-1 md:col-span-1 p-2 border border-gray-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                    <input type="text" id="snilsInput" placeholder="–°–ù–ò–õ–° (11 —Ü–∏—Ñ—Ä)" required pattern="\d{11}" maxlength="11"
                           class="col-span-1 md:col-span-1 p-2 border border-gray-300 rounded-md focus:ring-sky-500 focus:border-sky-500">
                    <button type="submit" class="col-span-1 bg-sky-500 text-white font-semibold py-2 rounded-md hover:bg-sky-600 transition-colors">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
                    </button>
                </form>

                <!-- –ö–Ω–æ–ø–∫–∏ –ò–º–ø–æ—Ä—Ç–∞/–≠–∫—Å–ø–æ—Ä—Ç–∞ -->
                <div class="mt-4 pt-4 border-t border-yellow-200 flex flex-col sm:flex-row gap-3">
                    <button id="exportMappingsButton" class="flex-1 bg-sky-600 text-white font-semibold py-2 rounded-md hover:bg-sky-700 transition-colors disabled:opacity-50" disabled>
                        üíæ –í—ã–≥—Ä—É–∑–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (.json)
                    </button>
                    <input type="file" id="importMappingsInput" accept=".json" class="hidden">
                    <button id="importMappingsButton" class="flex-1 bg-gray-300 text-gray-800 font-semibold py-2 rounded-md hover:bg-gray-400 transition-colors">
                        üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (.json)
                    </button>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π -->
                <details class="mt-4">
                    <summary class="font-medium text-gray-600 mb-2 cursor-pointer">
                        –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
                        <svg class="w-4 h-4 inline ml-1 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <ul id="mappingsList" class="divide-y divide-gray-100 bg-white p-3 rounded-lg border border-gray-200 mt-2">
                        <p class="text-sm text-gray-500 italic">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                    </ul>
                </details>
            </div>
        
            <!-- –ë–õ–û–ö 3: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –°–ù–ò–õ–° -->
            <div id="missingMappingsContainer" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                <h2 class="text-xl font-semibold text-red-700 mb-3 border-b pb-2 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    –®–∞–≥ 3: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –°–ù–ò–õ–° –¥–ª—è: <span id="missingCount" class="font-bold">0</span>&nbsp;–∞–≤—Ç–æ—Ä–æ–≤
                </h2>
                <p class="text-sm text-red-600 mb-4">
                    –í–≤–µ–¥–∏—Ç–µ –°–ù–ò–õ–° –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                </p>

                <div id="missingAuthorsList" class="space-y-3">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–º–∏ –§–ò–û –∏ –ø–æ–ª—è–º–∏ –≤–≤–æ–¥–∞ -->
                </div>

                <button id="forceConvertButton"
                        class="w-full mt-6 bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-yellow-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é (–¥–∞–∂–µ —Å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–º–∏ –°–ù–ò–õ–°)
                </button>
            </div>
            
            <!-- –ë–õ–û–ö 4: –°—Ç–∞—Ç—É—Å –∏ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ -->
            <div class="p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-1">
                    –®–∞–≥ 4: –°—Ç–∞—Ç—É—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                </h2>
                <div id="statusMessage" class="text-gray-600 text-lg font-semibold mb-4">
                    –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞...
                </div>
                <!-- Processing Animation -->
                <div id="processingIndicator" class="mt-4 hidden">
                    <div class="h-2.5 bg-sky-200 rounded-full overflow-hidden">
                        <div class="h-full bg-accent-sky rounded-full animate-progress-stripes"></div>
                    </div>
                    <p class="text-xs text-accent-sky mt-1 font-medium animate-pulse">–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                </div>
                <!-- –ö–Ω–æ–ø–∫–∞ —Å accent-emerald -->
                <button id="downloadButton"
                        class="w-full mt-4 bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-emerald-600 transition-colors duration-200 opacity-50 cursor-not-allowed disabled:shadow-none"
                        disabled>
                    –°–∫–∞—á–∞—Ç—å XML-—Ñ–∞–π–ª
                </button>
                <p id="recordCount" class="text-sm text-gray-500 mt-2 text-center hidden"></p>
            </div>
        </div>

        <!-- Debug Log Spoiler (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ª–æ–≥–∞) -->
        <details class="mt-8 p-4 bg-gray-100 border border-gray-300 rounded-lg" id="debugLogSpoiler">
            <summary class="flex justify-between items-center cursor-pointer font-semibold text-gray-700 focus:outline-none">
                <span>
                    <svg class="w-5 h-5 inline-block mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3a1 1 0 011-1h4a1 1 0 011 1v2M9 5h6m-6 4h6m-6 4h6m-6 4h6" />
                    </svg>
                    –õ–æ–≥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ / –û—Ç–ª–∞–¥–∫–∞
                </span>
                <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </summary>
            <div id="logDetails" class="mt-2 text-sm text-gray-700 overflow-auto h-40 bg-white p-2 rounded-lg border border-gray-200 shadow-inner">
                <!-- Log entries will appear here as structured HTML -->
            </div>
        </details>

        <!-- Footer Section with Copyright -->
        <footer class="mt-10 pt-6 border-t border-gray-200 text-center">
            <p class="text-xs text-gray-400">
                –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –°–ª—É–∂–±–æ–π –∏—Å–ø—ã—Ç–∞–Ω–∏–π, —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã –∏ –º–µ—Ç—Ä–æ–ª–æ–≥–∏–∏ –ì–ê–£ –ò–ù–ü–¶ "–ì–æ—Ä–º–µ–¥—Ç–µ—Ö–Ω–∏–∫–∞".
            </p>
        </footer>
    </div>

    <script type="module">
        // Global variables from Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const HEADER_SKIP_LINES = 3; 
        const MIN_PROCESSING_TIME = 1500; 

        // –ò–Ω–¥–µ–∫—Å—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ CSV-—Ñ–∞–π–ª–µ (–Ω–∞—á–∏–Ω–∞—è —Å 0)
        const COL_INDEX = {
            'Author': 1, // –ê–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
            'Type': 3, // –¢–∏–ø –°–ò
            'Date': 5, // –î–∞—Ç–∞ –ø–æ–≤–µ—Ä–∫–∏
            'Suitability': 9, // –ü—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å
            'Document': 10 // –ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
        };

        // --- FIREBASE STATE ---
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        // Map<NormalizedFullName (key), SNILS (value)>
        let snilsMap = new Map(); 
        // Array of full document snapshots for export/import
        let currentMappingsData = []; 

        // --- CONVERSION STATE ---
        let currentFileContent = null;
        let currentFilename = null;
        let missingAuthorsFromCurrentFile = new Set(); // Set<FullName>
        let isAnalysisPending = false; 

        // --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
        const fileInput = document.getElementById('fileInput');
        const dropArea = document.getElementById('drop-area');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const downloadButton = document.getElementById('downloadButton');
        const recordCountElement = document.getElementById('recordCount');
        const processingIndicator = document.getElementById('processingIndicator');
        const debugLogSpoiler = document.getElementById('debugLogSpoiler');
        const logDetails = document.getElementById('logDetails');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const addMappingForm = document.getElementById('addMappingForm');
        const authorNameInput = document.getElementById('authorNameInput');
        const snilsInput = document.getElementById('snilsInput');
        const missingMappingsContainer = document.getElementById('missingMappingsContainer');
        const missingAuthorsList = document.getElementById('missingAuthorsList');
        const missingCount = document.getElementById('missingCount');
        const forceConvertButton = document.getElementById('forceConvertButton');
        const fileUploadSection = document.getElementById('fileUploadSection');
        const exportMappingsButton = document.getElementById('exportMappingsButton');
        const importMappingsButton = document.getElementById('importMappingsButton');
        const importMappingsInput = document.getElementById('importMappingsInput');
        
        // --- –£–¢–ò–õ–ò–¢–´ ---
        let errorCount = 0;

        function updateUserIdDisplay(status, id = null) {
            userIdDisplay.textContent = `–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${status}. ${id ? 'ID: ' + id.substring(0, 8) + '...' : ''}`;
        }

        function startProcessingUI(message = '–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞...') {
            logDetails.innerHTML = ''; 
            errorCount = 0;
            statusMessage.textContent = message;
            statusMessage.classList.remove('text-red-600', 'text-yellow-600');
            statusMessage.classList.add('text-gray-600');
            processingIndicator.classList.remove('hidden');
            downloadButton.disabled = true;
            downloadButton.classList.add('opacity-50', 'cursor-not-allowed', 'disabled:shadow-none');
            downloadButton.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
            recordCountElement.classList.add('hidden');
            missingMappingsContainer.classList.add('hidden');
            fileUploadSection.classList.remove('hidden');
            missingAuthorsFromCurrentFile.clear();
        }

        function stopProcessingUI() {
            processingIndicator.classList.add('hidden');
            if (errorCount > 0) {
                 debugLogSpoiler.open = true; 
            }
        }

        function updateStatus(message, isError = false, isWarning = false) {
            statusMessage.textContent = message;
            let color = 'text-gray-600';
            if (isError) color = 'text-red-600';
            else if (isWarning) color = 'text-yellow-600';

            statusMessage.className = `font-semibold text-lg mb-4 ${color}`;
            if (isError) {
                downloadButton.disabled = true;
                downloadButton.classList.add('opacity-50', 'cursor-not-allowed', 'disabled:shadow-none');
                downloadButton.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
            }
        }

        function updateSuccess(count) {
            updateStatus('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é.', false);
            downloadButton.disabled = false;
            downloadButton.classList.remove('opacity-50', 'cursor-not-allowed', 'disabled:shadow-none');
            downloadButton.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
            recordCountElement.textContent = `–°–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${count}. –û—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫: ${errorCount}.`;
            recordCountElement.classList.remove('hidden');
        }
        
        function logMessage(message, level = 'INFO') {
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            
            let iconSvg = '';
            let textColor = 'text-gray-700';
            let levelColor = 'text-emerald-600'; 
            let levelDisplay = '–ò–ù–§–û';

            if (level === 'ERROR') {
                iconSvg = '<svg class="w-4 h-4 mr-1 flex-shrink-0 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg>';
                textColor = 'text-red-700';
                levelColor = 'text-red-600';
                levelDisplay = '–û–®–ò–ë–ö–ê';
                errorCount++;
            } else if (level === 'WARNING') {
                 iconSvg = '<svg class="w-4 h-4 mr-1 flex-shrink-0 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg>';
                textColor = 'text-yellow-700';
                levelColor = 'text-yellow-600';
                levelDisplay = '–í–ù–ò–ú–ê–ù–ò–ï';
            } else {
                iconSvg = '<svg class="w-4 h-4 mr-1 flex-shrink-0 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
            }

            const logEntryHtml = `
                <div class="flex items-start text-xs font-mono py-0 leading-snug">
                    ${iconSvg}
                    <span class="${levelColor} font-bold flex-shrink-0">[${timestamp}] [${levelDisplay}]:&nbsp;</span><span class="${textColor} break-words min-w-0 flex-1">${message}</span>
                </div>
            `;
            
            logDetails.innerHTML += logEntryHtml;
            logDetails.scrollTop = logDetails.scrollHeight; 
        }

        function logError(message) {
            logMessage(message, 'ERROR');
        }
        
        function getMappingsCollection() {
            const { collection } = window.firebaseImports;
            if (!db || !userId) return null;
            const path = `artifacts/${appId}/users/${userId}/snils_mappings`;
            return collection(db, path);
        }
        
        // --- FIREBASE LOGIC ---
        
        async function initFirebase() {
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebaseImports;
            
            if (!firebaseConfig.apiKey) {
                logError('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ.');
                isAuthReady = true;
                updateUserIdDisplay('–û–®–ò–ë–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò');
                return;
            }

            // setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.firebaseImports.app = app; // Store app for later use if needed

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    updateUserIdDisplay('–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω', userId);
                    loadMappings();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        logError(`–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}. –ü–æ–ø—ã—Ç–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.`);
                        await signInAnonymously(auth);
                    }
                }
            });
        }
        
        function loadMappings() {
            const { onSnapshot } = window.firebaseImports;

            const mappingsCol = getMappingsCollection();
            if (!mappingsCol) {
                logError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: Firestore –Ω–µ –≥–æ—Ç–æ–≤.');
                return;
            }
            
            onSnapshot(mappingsCol, (snapshot) => {
                snilsMap.clear();
                currentMappingsData = [];
                let htmlList = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const searchKey = data.fullName.toUpperCase().replace(/\s/g, ''); 
                    snilsMap.set(searchKey, data.snils);
                    
                    // Store the data for export
                    currentMappingsData.push({ id: id, fullName: data.fullName, snils: data.snils });

                    htmlList += `
                        <li class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                            <span class="font-medium text-gray-700 w-1/2 overflow-hidden text-ellipsis whitespace-nowrap">${data.fullName}</span>
                            <span class="font-mono text-gray-500 text-sm flex-shrink-0">${data.snils}</span>
                            <button onclick="window.deleteMapping('${id}')" title="–£–¥–∞–ª–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ" class="ml-4 text-red-500 hover:text-red-700 p-1 rounded-full bg-red-50 hover:bg-red-100 transition-colors">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </li>
                    `;
                });

                document.getElementById('mappingsList').innerHTML = htmlList || '<p class="text-sm text-gray-500 italic">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –°–ù–ò–õ–°-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ.</p>';
                logMessage(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${snilsMap.size} –°–ù–ò–õ–°-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π –∏–∑ Firestore.`);
                
                // Enable export button if there are mappings
                exportMappingsButton.disabled = currentMappingsData.length === 0;

                // If there was a pending analysis, rerun it to see if new mappings cover the missing authors
                if (isAnalysisPending) {
                     isAnalysisPending = false; // Reset flag
                     // Only proceed if file content is present (i.e., we paused after a file drop)
                     if (currentFileContent) {
                         // Rerunning the full file analysis will update the missing list UI
                         identifyMissingAuthorsInFile(currentFileContent, currentFilename); 
                     }
                }

            }, (error) => {
                logError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ SNILS-—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: ${error.message}`);
            });
        }
        
        window.deleteMapping = async (docId) => {
            const { deleteDoc, doc } = window.firebaseImports;
            if (!db || !userId) {
                logError('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å: Firestore –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.');
                return;
            }
            try {
                const path = `artifacts/${appId}/users/${userId}/snils_mappings`;
                await deleteDoc(doc(db, path, docId));
                logMessage(`–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å ID ${docId} —É–¥–∞–ª–µ–Ω–æ.`);
            } catch (e) {
                logError(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: ${e.message}`);
            }
        };
        
        addMappingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = authorNameInput.value.trim();
            const snils = snilsInput.value.trim();
            await saveMapping(fullName, snils);
            authorNameInput.value = '';
            snilsInput.value = '';
        });

        /**
         * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–¥–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤ Firestore.
         * @param {string} fullName –§–ò–û –∞–≤—Ç–æ—Ä–∞.
         * @param {string} snils –°–ù–ò–õ–° (11 —Ü–∏—Ñ—Ä).
         * @returns {Promise<boolean>} –£—Å–ø–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–∏.
         */
        async function saveMapping(fullName, snils) {
            const { addDoc } = window.firebaseImports;
            if (!isAuthReady || !db) {
                logError('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: –î–æ–∂–¥–∏—Ç–µ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firestore.');
                return false;
            }

            // Simple validation
            const snilsRegex = /^\d{11}$/;
            if (!fullName || !snilsRegex.test(snils)) {
                logError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –§–ò–û –∏ –°–ù–ò–õ–° (11 —Ü–∏—Ñ—Ä) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.');
                return false;
            }

            try {
                const mappingsCol = getMappingsCollection();
                await addDoc(mappingsCol, {
                    fullName: fullName,
                    snils: snils
                });
                logMessage(`–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ: ${fullName} -> ${snils}`);
                return true;
            } catch (error) {
                logError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: ${error.message}`);
                return false;
            }
        }
        
        // --- –õ–û–ì–ò–ö–ê –ò–ú–ü–û–†–¢–ê/–≠–ö–°–ü–û–†–¢–ê ---

        function handleExportMappings() {
            if (currentMappingsData.length === 0) {
                logMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
                return;
            }

            const exportPayload = {
                timestamp: new Date().toISOString(),
                format: "FGIS_SNILS_MAPPINGS_V1", // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–∞—Ç–∏–Ω–∏—Ü—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                description: "Exported SNILS mappings for FGIS FSA converter.",
                mappings: currentMappingsData.map(d => ({ fullName: d.fullName, snils: d.snils }))
            };

            const dataStr = JSON.stringify(exportPayload, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `fgis_snils_mappings_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logMessage(`–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (${currentMappingsData.length} –∑–∞–ø–∏—Å–µ–π) –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤ JSON-—Ñ–∞–π–ª.`);
        }

        async function handleImportMappings(file) {
            const { getDocs, query, writeBatch, doc } = window.firebaseImports;
            
            if (!isAuthReady || !db) {
                logError('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: Firestore –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å—Ç–∞—Ç—É—Å–∞ "–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω".');
                updateStatus("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π.", true); // –ß–µ—Ç–∫–∞—è –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                return;
            }
            
            logMessage(`–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–º–ø–æ—Ä—Ç–∞: ${file.name}...`);

            const reader = new FileReader();
            
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö –£–°–ü–ï–®–ù–û–ì–û –ß–¢–ï–ù–ò–Ø
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫—É—é –≤–µ—Ä—Å–∏—é —Ñ–æ—Ä–º–∞—Ç–∞ –≤ —Ñ–∞–π–ª–µ –∏–º–ø–æ—Ä—Ç–∞
                    const allowedFormats = ["FGIS_SNILS_MAPPINGS_V1", "FGIS_–°–ù–ò–õ–°_MAPPINGS_V1"];
                    
                    if (!allowedFormats.includes(importedData.format) || !Array.isArray(importedData.mappings)) {
                        throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π. –û–∂–∏–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏–∑: ${allowedFormats.join(', ')}.`);
                    }

                    const newMappings = importedData.mappings;
                    if (newMappings.length === 0) {
                        logMessage('–§–∞–π–ª –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π. –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.');
                        return;
                    }
                    
                    const mappingsCol = getMappingsCollection();
                    const batch = writeBatch(db);
                    let importedCount = 0;
                    
                    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
                    const existingDocs = await getDocs(query(mappingsCol));
                    existingDocs.forEach(d => {
                        batch.delete(d.ref);
                    });

                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π
                    newMappings.forEach(mapping => {
                        if (mapping.fullName && mapping.snils && /^\d{11}$/.test(mapping.snils)) {
                            const newDocRef = doc(mappingsCol);
                            batch.set(newDocRef, { 
                                fullName: mapping.fullName, 
                                snils: mapping.snils 
                            });
                            importedCount++;
                        } else {
                            logError(`–ü—Ä–æ–ø—É—â–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –∏–º–ø–æ—Ä—Ç–µ: –§–ò–û: ${mapping.fullName || 'N/A'}, –°–ù–ò–õ–°: ${mapping.snils || 'N/A'}`);
                        }
                    });

                    await batch.commit();
                    logMessage(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –û—á–∏—â–µ–Ω–æ ${existingDocs.size} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${importedCount} –Ω–æ–≤—ã—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π.`);
                    updateStatus(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ ${importedCount} —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π.`);

                } catch (error) {
                    // –Ø–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
                    logError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON: ${error.message}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω.`);
                    updateStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥.`, true); 
                }
            };
            
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–®–ò–ë–ö–ò –ß–¢–ï–ù–ò–Ø –§–ê–ô–õ–ê
            reader.onerror = (e) => {
                logError(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${e.target.error.name}.`);
                updateStatus(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${e.target.error.name}`, true);
            };

            reader.readAsText(file);
        }


        // --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê –ò –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ---
        
        function getParsedDataLines(csvContent, usedDelimiter) {
             const lines = csvContent.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= HEADER_SKIP_LINES) return [];

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            const dataLines = lines.slice(HEADER_SKIP_LINES);
            if (dataLines.length === 0) return [];
            
            const firstDataLine = dataLines[0];
            let effectiveDelimiter = usedDelimiter; 

            if (!effectiveDelimiter) {
                // –ü—ã—Ç–∞–µ–º—Å—è —É–≥–∞–¥–∞—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                const commaCount = (firstDataLine.match(/,/g) || []).length;
                const semicolonCount = (firstDataLine.match(/;/g) || []).length;

                // –î–ª—è –ê–†–®–ò–ù —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ';'
                if (semicolonCount > commaCount + 2) {
                    effectiveDelimiter = ';';
                } else {
                    effectiveDelimiter = ',';
                }
                logMessage(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: "${effectiveDelimiter}".`);
            }
            
            const dataRecords = dataLines.map((line, index) => {
                if (!line.trim()) return [];
                const fields = [];
                let currentField = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === effectiveDelimiter && !inQuotes) {
                        fields.push(currentField.trim().replace(/^"|"$/g, ''));
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                fields.push(currentField.trim().replace(/^"|"$/g, ''));

                while (fields.length > 0 && fields[fields.length - 1] === '') {
                    fields.pop();
                }
                return fields;
            }).filter(fields => fields.length > COL_INDEX.Document); 
            
            return dataRecords;
        }

        /**
         * –®–∞–≥ 1: –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –°–ù–ò–õ–°.
         */
        function identifyMissingAuthors(csvContent) {
            const allAuthors = new Set();
            const missingAuthors = new Set();
            
            const dataRecords = getParsedDataLines(csvContent, null);

            for (const fields of dataRecords) {
                if (fields.length > COL_INDEX.Author) {
                    const authorFull = fields[COL_INDEX.Author].trim();
                    if (authorFull) {
                        // FIX: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º.
                        // –°—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ "–ê–≤—Ç–æ—Ä: –ê–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏" –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∫–∞–∫ [0]: "–ê–≤—Ç–æ—Ä", [1]: "–ê–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏"
                        if (authorFull.toLowerCase() === '–∞–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏') {
                            logMessage('–û–±–Ω–∞—Ä—É–∂–µ–Ω –∏ –ø—Ä–æ–ø—É—â–µ–Ω –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ê–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É HEADER_SKIP_LINES.', 'WARNING');
                            continue;
                        }

                        allAuthors.add(authorFull);
                        const searchKey = authorFull.toUpperCase().replace(/\s/g, '');
                        if (!snilsMap.has(searchKey)) {
                            missingAuthors.add(authorFull);
                        }
                    }
                }
            }
            return missingAuthors;
        }

        /**
         * –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç XML-—Ñ–∞–π–ª, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–µ–∫—É—â–∏–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è.
         */
        function generateFinalXML(csvContent) {
            let recordCount = 0;
            let currentErrors = 0; 
            
            const dataRecords = getParsedDataLines(csvContent, null);
            if (dataRecords.length === 0) return { status: 'NO_RECORDS' };

            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<Message xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="schema.xsd">\n';
            xml += '    <VerificationMeasuringInstrumentData>\n';
            
            for (let i = 0; i < dataRecords.length; i++) {
                const fields = dataRecords[i];
                const lineNumber = i + HEADER_SKIP_LINES + 1; // –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –æ—Ç—Å—á–µ—Ç —Å—Ç—Ä–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1

                if (fields.length < COL_INDEX.Document + 1) {
                    logError(`–°—Ç—Ä–æ–∫–∞ ${lineNumber}: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª–µ–π. –ü—Ä–æ–ø—É—â–µ–Ω–∞.`);
                    currentErrors++;
                    continue;
                }

                try {
                    const authorFull = fields[COL_INDEX.Author].trim();
                    const documentNum = fields[COL_INDEX.Document];
                    const dateVerification = fields[COL_INDEX.Date];
                    const typeInstrument = fields[COL_INDEX.Type];
                    const suitabilityText = fields[COL_INDEX.Suitability];
                    
                    if (authorFull.toLowerCase() === '–∞–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏') {
                        logMessage(`–°—Ç—Ä–æ–∫–∞ ${lineNumber}: –ü—Ä–æ–ø—É—â–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è "–ê–≤—Ç–æ—Ä –∑–∞–ø–∏—Å–∏".`, 'WARNING');
                        continue;
                    }

                    if (!documentNum || documentNum.trim() === '') {
                        logError(`–°—Ç—Ä–æ–∫–∞ ${lineNumber}: –ü—Ä–æ–ø—É—â–µ–Ω–∞, –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞.`);
                        currentErrors++;
                        continue;
                    }
                    
                    // --- –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –°–ù–ò–õ–° (–ö–†–ò–¢–ò–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê) ---
                    const searchKey = authorFull.toUpperCase().replace(/\s/g, '');
                    let effectiveSNILS = snilsMap.get(searchKey);

                    if (!effectiveSNILS) {
                        logError(`–°—Ç—Ä–æ–∫–∞ ${lineNumber} (${documentNum}): –ü—Ä–æ–ø—É—â–µ–Ω–∞. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –°–ù–ò–õ–° –¥–ª—è –∞–≤—Ç–æ—Ä–∞ "${authorFull}".`);
                        currentErrors++;
                        continue;
                    }

                    // –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –§–ò–û
                    const authorParts = authorFull.split(/\s+/).filter(p => p.length > 0);
                    const lastName = authorParts[0] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
                    const firstName = authorParts.slice(1).join(' ') || "–ê–≤—Ç–æ—Ä";
                    
                    const dateVerificationClean = dateVerification.split(' ')[0];
                    const formattedDateVerification = window.formatDateToISO(dateVerificationClean);
                    
                    if (formattedDateVerification === "") {
                         logError(`–°—Ç—Ä–æ–∫–∞ ${lineNumber} (${documentNum}): –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –¥–∞—Ç—É "${dateVerificationClean}". –ó–∞–ø–∏—Å—å –ø—Ä–æ–ø—É—â–µ–Ω–∞.`);
                         currentErrors++;
                         continue;
                    }

                    const dateEndVerification = window.calculateDateEndVerification(dateVerificationClean);
                    const resultVerification = window.mapSuitability(suitabilityText);
                    
                    const escape = (str) => str ? str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;') : '';

                    xml += '        <VerificationMeasuringInstrument>\n';
                    xml += `            <NumberVerification>${escape(documentNum)}</NumberVerification>\n`;
                    xml += `            <DateVerification>${escape(formattedDateVerification)}</DateVerification>\n`;
                    
                    if (resultVerification === '1') {
                        xml += `            <DateEndVerification>${escape(dateEndVerification)}</DateEndVerification>\n`;
                    }

                    xml += `            <TypeMeasuringInstrument>${escape(typeInstrument)}</TypeMeasuringInstrument>\n`;
                    xml += '            <ApprovedEmployees>\n';
                    xml += '                <Name>\n';
                    xml += `                    <Last>${escape(lastName)}</Last>\n`;
                    xml += `                    <First>${escape(firstName)}</First>\n`;
                    xml += '                </Name>\n';
                    xml += `                <SNILS>${effectiveSNILS}</SNILS>\n`;
                    xml += '            </ApprovedEmployees>\n';
                    xml += `            <ResultVerification>${resultVerification}</ResultVerification>\n`;
                    xml += '        </VerificationMeasuringInstrument>\n';
                    
                    recordCount++;

                } catch (e) {
                    logError(`–°—Ç—Ä–æ–∫–∞ ${lineNumber}: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${e.message}. –ó–∞–ø–∏—Å—å –ø—Ä–æ–ø—É—â–µ–Ω–∞.`);
                    currentErrors++;
                }
            }
            
            errorCount = currentErrors; // Update global counter

            if (recordCount > 0) {
                xml += '    </VerificationMeasuringInstrumentData>\n';
                xml += '    <SaveMethod>2</SaveMethod>\n';
                xml += '</Message>';
                return { status: 'SUCCESS', xmlContent: xml, recordCount: recordCount };
            } else {
                return { status: 'NO_RECORDS' };
            }
        }
        
        // --- UI LOGIC FOR MISSING MAPPINGS ---
        
        function displayMissingAuthors(authorsSet) {
            missingAuthorsFromCurrentFile = authorsSet;
            const authorsArray = Array.from(authorsSet).sort();
            missingCount.textContent = authorsArray.length;
            missingAuthorsList.innerHTML = '';
            
            if (authorsArray.length === 0) {
                 updateStatus('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –í—Å–µ –°–ù–ò–õ–° –Ω–∞–π–¥–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é" –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ XML.', false);
                 forceConvertButton.textContent = '–ù–∞—á–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é';
                 forceConvertButton.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                 forceConvertButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                 missingMappingsContainer.classList.remove('hidden');
                 return;
            }

            updateStatus('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –°–ù–ò–õ–°.', false, true);
            fileUploadSection.classList.add('hidden');
            missingMappingsContainer.classList.remove('hidden');

            authorsArray.forEach(author => {
                const cleanId = author.replace(/[^a-zA-Z0-9]/g, '_');
                const card = document.createElement('div');
                card.className = 'p-4 bg-white rounded-lg shadow-sm border border-red-100';
                card.innerHTML = `
                    <p class="font-bold text-gray-800 mb-2 truncate" title="${author}">–ê–≤—Ç–æ—Ä: ${author}</p>
                    <form data-author="${author}" class="snils-save-form flex space-x-2">
                        <input type="text" id="snils-${cleanId}" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ 11 —Ü–∏—Ñ—Ä –°–ù–ò–õ–°" required pattern="\\d{11}" maxlength="11"
                               class="flex-grow p-2 border border-red-300 rounded-md focus:ring-red-500 focus:border-red-500 text-sm">
                        <button type="submit" class="flex-shrink-0 bg-red-500 text-white text-sm px-4 py-2 rounded-md hover:bg-red-600 transition-colors">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </form>
                `;
                missingAuthorsList.appendChild(card);
                
                // Attach event listener to the form
                card.querySelector('.snils-save-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const targetForm = e.target;
                    const input = targetForm.querySelector('input');
                    const button = targetForm.querySelector('button');
                    
                    const authorName = targetForm.dataset.author;
                    const snilsValue = input.value.trim();

                    if (snilsValue.length === 11 && /^\d{11}$/.test(snilsValue)) {
                        button.disabled = true;
                        button.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                        const success = await saveMapping(authorName, snilsValue);
                        if (success) {
                             isAnalysisPending = true; // Reruns analysis after onSnapshot fires
                        } else {
                             button.disabled = false;
                             button.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        }
                    } else {
                        logError('–°–ù–ò–õ–° –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 11 —Ü–∏—Ñ—Ä.');
                    }
                });
            });

            forceConvertButton.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é (–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ)';
            forceConvertButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
            forceConvertButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
        }

        // --- –ì–õ–ê–í–ù–´–ô –ö–û–ù–¢–†–û–õ–õ–ï–† –§–ê–ô–õ–û–í –ò –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ---

        async function startConversion(content, filename, isFinalRun = false) {
            if (!isAuthReady) {
                 updateStatus("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –°–ù–ò–õ–°...", false);
                 return;
            }

            currentFileContent = content;
            currentFilename = filename;
            
            startProcessingUI(isFinalRun ? '–§–∏–Ω–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è XML...' : '–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –°–ù–ò–õ–°...');
            const startTime = performance.now();

            if (!isFinalRun) {
                // --- –®–ê–ì 1: –ê–ù–ê–õ–ò–ó ---
                const missingAuthors = identifyMissingAuthors(content);
                missingAuthorsFromCurrentFile = missingAuthors; 
                logMessage(`–ù–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –°–ù–ò–õ–°: ${missingAuthors.size}`);

                if (missingAuthors.size > 0) {
                    const elapsedTime = performance.now() - startTime;
                    const delay = Math.max(0, MIN_PROCESSING_TIME - elapsedTime);
                    
                    setTimeout(() => {
                        stopProcessingUI();
                        displayMissingAuthors(missingAuthors);
                    }, delay);
                    return; // PAUSE
                } else {
                    logMessage('–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –°–ù–ò–õ–° –Ω–∞–π–¥–µ–Ω—ã. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ XML.');
                    isFinalRun = true; 
                }
            }

            // --- –®–ê–ì 2: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø XML ---
            let finalXmlContent = null;
            let result = null;

            try {
                result = generateFinalXML(content);

                if (result.status === 'SUCCESS') {
                    finalXmlContent = result.xmlContent;
                } else if (result.status === 'NO_RECORDS') {
                    throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.");
                }

            } catch(e) {
                 logError(`–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${e.message}`);
                 finalXmlContent = null;
            }

            // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            const elapsedTime = performance.now() - startTime;
            const delay = Math.max(0, MIN_PROCESSING_TIME - elapsedTime);

            setTimeout(() => {
                stopProcessingUI();
                
                if (finalXmlContent) {
                    updateSuccess(result.recordCount);
                    downloadButton.onclick = () => window.downloadXML(finalXmlContent, window.generateFileName());
                    // Clear state
                    missingMappingsContainer.classList.add('hidden');
                    fileUploadSection.classList.remove('hidden');
                } else {
                    updateStatus("–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏ –∏–ª–∏ –±–µ–∑ –∑–∞–ø–∏—Å–µ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥.", true);
                }
            }, delay);
        }
        
        // --- –£–¢–ò–õ–ò–¢–ê–†–ù–´–ï –ú–ï–¢–û–î–´ (–í–´–ù–ï–°–ï–ù–´ –í WINDOW –î–õ–Ø –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –î–û–°–¢–£–ü–ê) ---
        window.parseDate = function(dateStr) {
            const formats = ["YYYY-MM-DD", "DD.MM.YYYY", "DD-MM-YYYY"];
            const cleanDateStr = dateStr.trim().split(' ')[0];

            for (const format of formats) {
                const parts = cleanDateStr.match(/(\d+)/g); 
                if (parts && parts.length === 3) {
                    let year, month, day;

                    if (format === "YYYY-MM-DD") {
                        [year, month, day] = parts.map(Number);
                    } else { 
                        [day, month, year] = parts.map(Number);
                    }
                    if (year < 100) year += 2000;

                    const dateObj = new Date(year, month - 1, day);
                    if (dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                        return dateObj;
                    }
                }
            }
            return null; 
        };
        
        window.formatDateToISO = function(dateStr) {
            const dt = window.parseDate(dateStr);
            if (!dt) return ""; 
            const y = dt.getFullYear();
            const m = String(dt.getMonth() + 1).padStart(2, '0');
            const d = String(dt.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        window.mapSuitability = function(suitabilityText) {
            const text = suitabilityText.trim().toLowerCase();
            if (text === "–¥–∞" || text === "yes" || text === "–≥–æ–¥–µ–Ω") return '1';
            if (text === "–Ω–µ—Ç" || text === "no" || text === "–Ω–µ –≥–æ–¥–µ–Ω") return '2';
            logError(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞: "${suitabilityText}". –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: "–î–∞" (1).`);
            return '1'; 
        };

        window.calculateDateEndVerification = function(dateVerificationStr) {
            const dtStart = window.parseDate(dateVerificationStr);
            if (!dtStart) return ""; 

            const dtEnd = new Date(dtStart.getTime()); 
            dtEnd.setFullYear(dtStart.getFullYear() + 2);
            dtEnd.setDate(dtEnd.getDate() - 1); // –û–¥–∏–Ω –¥–µ–Ω—å –¥–æ –¥–≤—É—Ö –ª–µ—Ç

            const y = dtEnd.getFullYear();
            const m = String(dtEnd.getMonth() + 1).padStart(2, '0');
            const d = String(dtEnd.getDate()).padStart(2, '0');
            
            return `${y}-${m}-${d}`;
        };
        
        window.generateFileName = function() {
            const now = new Date();
            const y = String(now.getFullYear());
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            
            return `${y}${m}${d}_${hh}${mm}${ss}_output.xml`;
        };
        
        window.downloadXML = function(xmlContent, filename) {
            const blob = new Blob([xmlContent], { type: 'text/xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            logMessage(`XML-—Ñ–∞–π–ª "${filename}" —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω.`);
        }
        
        function readFileWithEncoding(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, encoding);
            });
        }

        function hasEncodingIssues(text) {
            // Check for Unicode replacement character
            return text.includes('\uFFFD');
        }

        async function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];
            if (!file.name.toLowerCase().endsWith('.csv')) {
                updateStatus("–û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª CSV.", true);
                logError(`–í—ã–±—Ä–∞–Ω –Ω–µ CSV —Ñ–∞–π–ª: ${file.name}`);
                return;
            }
            
            fileNameDisplay.textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}`;
            
            try {
                logMessage('–ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π UTF-8...');
                let content = await readFileWithEncoding(file, 'UTF-8');
                
                if (hasEncodingIssues(content)) {
                    logMessage('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π Windows-1251...');
                    content = await readFileWithEncoding(file, 'windows-1251');
                    logMessage(`–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏ Windows-1251.`);
                } else {
                    logMessage('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π UTF-8.');
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
                await startConversion(content, file.name);

            } catch(e) {
                 logError(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${e.message}`);
                 updateStatus(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${e.message}`, true);
                 stopProcessingUI();
            }
        }

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò DOM ---
        
        // Drop Area Events
        dropArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            e.target.value = null; 
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, window.preventDefaults, false);
            document.body.addEventListener(eventName, window.preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('active'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('active'), false);
        });

        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }, false);

        window.preventDefaults = function(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        forceConvertButton.addEventListener('click', () => {
             if (currentFileContent) {
                 logMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é.');
                 // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
                 startConversion(currentFileContent, currentFilename, true); 
             } else {
                 logError('–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.');
             }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ò–º–ø–æ—Ä—Ç–∞/–≠–∫—Å–ø–æ—Ä—Ç–∞
        exportMappingsButton.addEventListener('click', handleExportMappings);

        importMappingsButton.addEventListener('click', () => {
            importMappingsInput.click();
        });

        importMappingsInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImportMappings(file);
            }
            e.target.value = null; // Reset input
        });


        // –ó–∞–ø—É—Å–∫ Firebase
        initFirebase();
        updateStatus("–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π –°–ù–ò–õ–°.");
    </script>
</body>
</html>
